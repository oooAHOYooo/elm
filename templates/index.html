{% extends "base.html" %}
{% block content %}
<div class="dashboard" id="js-fit">
    <header class="masthead">
        <div class="masthead__title">
            <h1>{{ app_name or "Elm City Daily" }}</h1>
        </div>
        <p class="masthead__date">{{ date_str }}</p>
        <div class="masthead__lines" aria-hidden="true"></div>
    </header>

    <main class="grid">
        <section class="panel panel--left">
            <!-- Mobile Utility Toggle -->
            <button class="ecd-mobile-accordion-toggle" id="js-utils-toggle" type="button" aria-expanded="false" aria-controls="js-mobile-utils">
                <span class="ecd-site-title">Elm City Daily</span>
                <span class="ecd-mobile-status" id="js-mobile-status-text">
                    <!-- Populated by JS -->
                </span>
                <span class="ecd-mobile-chevron" aria-hidden="true">‚ñæ</span>
            </button>

            <div id="js-mobile-utils" class="ecd-header-utilities">
                <h2 class="panel__title">Local Time & Weather</h2>
                <div class="weather-mini" aria-label="Weather information">
                <div class="weather-mini__controls">
                    <label for="js-units" class="sr-only">Units</label>
                    <select id="js-units" aria-label="Units">
                        <option value="F" selected>¬∞F</option>
                        <option value="C">¬∞C</option>
                    </select>
                </div>
                <div id="js-weather-output" class="weather-mini__output">Weather loading‚Ä¶</div>
            </div>

            <div class="tides-mini" aria-label="Tidal information">
                <div class="tides-mini__controls">
                    <label for="js-tide-date" class="sr-only">Date</label>
                    <select id="js-tide-date" aria-label="Date">
                        <option value="today">Today</option>
                        <option value="tomorrow">Tomorrow</option>
                    </select>
                </div>
                <div id="js-tide-output" class="tides-mini__output">Tides
                    loading‚Ä¶</div>
            </div>

            {# History sections omitted for now #}
            <div class="change-nh" role="region"
                aria-label="Change New Haven quick actions">
                <div class="change-nh__title">Change New Haven</div>
                <div class="change-nh__actions">
                    <a class="change-nh__btn" href="tel:+12039465128"
                        title="Zoning (Call)">
                        <span class="change-nh__icon">‚òéÔ∏è</span><span
                            class="change-nh__label">Zoning</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://newhavenct.legistar.com" target="_blank"
                        rel="noopener" title="Legistar">
                        <span class="change-nh__icon">üìÑ</span><span
                            class="change-nh__label">Legistar</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://cityofnewhaven.com/civicax/citycalendar/calendarjson"
                        target="_blank" rel="noopener" title="Calendar JSON">
                        <span class="change-nh__icon">üóìÔ∏è</span><span
                            class="change-nh__label">Calendar</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://www.newhavenct.gov/government/departments-divisions/city-plan"
                        target="_blank" rel="noopener" title="City Plan Dept">
                        <span class="change-nh__icon">üèõÔ∏è</span><span
                            class="change-nh__label">City Plan</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://maps.newhavenct.gov/" target="_blank"
                        rel="noopener" title="Maps">
                        <span class="change-nh__icon">üó∫Ô∏è</span><span
                            class="change-nh__label">Maps</span>
                    </a>
                </div>
            </div>
            {# Recent council actions omitted #}
            </div> <!-- End ecd-header-utilities -->
        </section>

        <section class="panel panel--center">
            <div class="this-week">
                <header class="week-header desktop-only">
                    <button id="js-week-prev" class="week-nav week-nav-prev" aria-label="Previous week">‚Äπ</button>
                    <div id="js-week-label" class="week-label">Week of {{ week_start_date|default('this week') }}</div>
                    <button id="js-week-next" class="week-nav week-nav-next" aria-label="Next week">‚Ä∫</button>
                </header>

                <div class="ecd-week-wrapper mobile-only">
                     <button class="ecd-week-nav ecd-week-nav--prev" id="js-mobile-week-prev" aria-label="Previous week">‚Äπ</button>
                     <div class="ecd-week-days-scroll" id="js-mobile-week-scroll">
                         <!-- Populated by JS -->
                     </div>
                     <button class="ecd-week-nav ecd-week-nav--next" id="js-mobile-week-next" aria-label="Next week">‚Ä∫</button>
                </div>

                <div class="week-grid desktop-only" id="js-agenda-week">
                    {% for day in week_grid %}
                    <div class="week-day-column">
                        <div class="week-day-header">{{ day.label }}</div>
                        <div class="week-day-body">
                            {% for it in day['items'] %}
                            <button class="week-event-item" type="button"
                                data-title="{{ it.title }}"
                                data-time="{{ it.time }}"
                                data-link="{{ it.link }}"
                                data-location="{{ it.location }}"
                                data-source="{{ it.source }}"
                                data-date="{{ it.date }}"
                                data-summary="{{ it.summary | e }}">
                                <div class="week-event-time">{{ it.time }}</div>
                                <div class="week-event-title">{{ it.title }}</div>
                            </button>
                            {% else %}
                            <div class="week-day-empty">‚Äî</div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="ecd-mobile-events mobile-only">
                     <h2 class="ecd-section-heading">Today</h2>
                     <div class="ecd-mobile-events-today" id="js-mobile-events-today">
                         <!-- Populated by JS -->
                     </div>
                     
                     <h2 class="ecd-section-heading">This Week</h2>
                     <div class="ecd-mobile-events-week" id="js-mobile-events-week">
                        {% for day in week_grid %}
                            {% for it in day['items'] %}
                            <article class="ecd-event-card" 
                                data-date="{{ it.date }}"
                                data-title="{{ it.title }}"
                                data-time="{{ it.time }}"
                                data-link="{{ it.link }}"
                                data-location="{{ it.location }}"
                                data-source="{{ it.source }}"
                                data-summary="{{ it.summary | e }}">
                                <div class="ecd-event-time">{{ it.time }}</div>
                                <div class="ecd-event-title">{{ it.title }}</div>
                                <div class="ecd-event-meta">
                                    {% if it.location %}{{ it.location }}{% endif %}
                                </div>
                            </article>
                            {% endfor %}
                        {% endfor %}
                     </div>
                </div>

                <aside class="week-details ecd-event-details" id="js-detail" aria-label="Event details">
                    <button class="ecd-details-close mobile-only" id="js-details-close" aria-label="Close">√ó</button>
                    <div class="week-details-card" data-empty="true">
                        <div class="week-details-heading">Details</div>
                        <h3 class="week-details-title" id="js-detail-title">Select an event</h3>
                        
                        <div class="week-details-meta">
                            <div class="week-details-row">
                                <span class="label">WHEN</span>
                                <span class="value" id="js-detail-when">‚Äî</span>
                            </div>
                            <div class="week-details-row">
                                <span class="label">WHERE</span>
                                <span class="value" id="js-detail-where">‚Äî</span>
                            </div>
                            <div class="week-details-row">
                                <span class="label">SOURCE</span>
                                <span class="value" id="js-detail-source">‚Äî</span>
                            </div>
                        </div>

                        <hr class="week-details-separator">

                        <div class="week-details-section">
                            <span class="label">ABOUT</span>
                            <div class="week-details-about" id="js-detail-summary"></div>
                        </div>

                        <a class="week-details-link" id="js-detail-link" href="#" target="_blank" rel="noopener" style="display:none;">
                            ‚Üó Open link
                        </a>
                    </div>
                </aside>
                <input type="hidden" id="js-week-offset" value="0" />
            </div>
        </section>

        <aside class="panel panel--right">
            <div class="boards">
                <h3 class="filters__title">Upcoming Boards & Commissions</h3>
                <ul class="list">
                    {% for b in boards_upcoming %}
                    <li class="list__item">
                        <a class="list__link" href="{{ b.link or '#' }}"
                            target="_blank" rel="noopener">
                            <span class="list__source">{{ b.source }} ¬∑ {{
                                b.date }}</span>
                            <span class="list__title">{{ b.title }}</span>
                        </a>
                    </li>
                    {% else %}
                    <li class="list__item list__item--empty">No upcoming
                        meetings.</li>
                    {% endfor %}
                </ul>
            </div>
            
            <button class="ecd-mobile-accordion-toggle ecd-city-map-toggle" id="js-map-toggle" type="button" aria-expanded="false" aria-controls="js-map-stats">
                <span>City Map &amp; Stats</span>
                <span class="ecd-mobile-chevron" aria-hidden="true">‚ñæ</span>
            </button>

            <div class="ecd-city-map-stats" id="js-map-stats">
            <div class="map-controls">
                <label for="js-map-select" class="sr-only">Map Layer</label>
                <select id="js-map-select" class="map-controls__select"
                    aria-label="Select map type">
                    <option value="mapnik">General Map</option>
                    <option value="opentopomap">Topographic</option>
                    <option value="cyclemap">Cycle Routes</option>
                    <option value="transportmap">Public Transport</option>
                </select>
            </div>
            <div class="mapbox" role="region" aria-label="Map of New Haven">
                <iframe id="js-map-frame" title="New Haven Map" loading="lazy"
                    data-lat="{{ center_lat }}"
                    data-lon="{{ center_lon }}"></iframe>
            </div>
            <h2 class="panel__title">City by the Numbers</h2>
            <div class="stats stats--compact">
                <div class="stat">
                    <div class="stat__value">{{ civics_stats.introduced }}</div>
                    <div class="stat__label">Matters ({{ civics_stats.since[:10]
                        if civics_stats.since }})</div>
                </div>
                <div class="stat">
                    <div class="stat__value">{{ civics_stats.adopted }}</div>
                    <div class="stat__label">Adopted</div>
                </div>
                <div class="stat">
                    <div class="stat__value">{{ civics_stats.failed }}</div>
                    <div class="stat__label">Failed</div>
                </div>
                <div class="stat">
                    <div class="stat__value">{{ civics_stats.projects_open
                        }}</div>
                    <div class="stat__label">Projects</div>
                </div>
                {% if tax_info and tax_info.mill_rate %}
                <div class="stat">
                    <div class="stat__value">{{
                        '%.2f'|format(tax_info.mill_rate) }}</div>
                    <div class="stat__label">Mill (FY {{ tax_info.fiscal_year
                        }})</div>
                </div>
                {% endif %}
            </div>

            <div class="filters">
                <h3 class="filters__title">Filters</h3>
                <label class="checkbox">
                    <input type="checkbox" class="js-filter"
                        data-category="news" checked />
                    <span>News</span>
                </label>
                <label class="checkbox">
                    <input type="checkbox" class="js-filter"
                        data-category="events" checked />
                    <span>Events</span>
                </label>
                <label class="checkbox">
                    <input type="checkbox" class="js-filter"
                        data-category="weather" checked />
                    <span>Weather</span>
                </label>
            </div>
            <div class="alerts">
                <h3 class="filters__title">NWS Alerts</h3>
                <ul class="list list--rail">
                    {% if nws_alerts and nws_alerts|length > 0 %}
                    {% for al in nws_alerts %}
                    <li class="list__item">
                        <a class="list__link" href="{{ al.link }}"
                            target="_blank"
                            rel="noopener">
                            <span class="list__source">{{ al.event }}</span>
                            <span class="list__title">{{ al.title }}</span>
                        </a>
                    </li>
                    {% endfor %}
                    {% else %}
                    <li class="list__item list__item--empty">No active
                        alerts.</li>
                    {% endif %}
                </ul>
            </div>

            <ul class="list list--rail">
                {% for item in right_rail_items %}
                <li class="list__item">
                    <a class="list__link" href="{{ item.link }}" target="_blank"
                        rel="noopener">
                        <span class="list__source">{{ item.source }}</span>
                        <span class="list__title">{{ item.title }}</span>
                    </a>
                </li>
                {% endfor %}
            </ul>
            </div> <!-- End ecd-city-map-stats -->
        </aside>
    </main>

    <section class="strip desktop-only">
        <div class="strip__inner">
            {% for item in bottom_strip_items %}
            {% if item.category == 'events' %}
            <div class="card" data-category="events">
                <div class="card__badge">Event</div>
                <div class="card__title">{{ item.title }}</div>
                <div class="card__meta">
                    {% if item.location %}{{ item.location }} ¬∑ {% endif %}
                    {% if item.published_display %}{{ item.published_display
                    }}{% endif %}
                </div>
            </div>
            {% elif item.category == 'weather' %}
            <div class="card" data-category="weather">
                <div class="card__badge">Weather</div>
                <div class="card__title">{{ item.title }}</div>
                <div class="card__meta">{{ item.summary }}</div>
            </div>
            {% else %}
            <a class="card" href="{{ item.link }}" target="_blank"
                rel="noopener" data-category="news">
                <div class="card__badge">News</div>
                <div class="card__title">{{ item.title }}</div>
                <div class="card__meta">{{ item.source }}</div>
            </a>
            {% endif %}
            {% endfor %}
        </div>
    </section>
    <footer class="footer-mini">
        <nav class="footer-mini__nav">
            <a href="{{ url_for('about') }}">About</a>
            <a href="{{ url_for('feeds_view') }}">Feeds</a>
            <a href="{{ url_for('feeds_api') }}">API</a>
            <span class="mobile-only">¬© Elm City Daily</span>
        </nav>
        <div class="footer-mini__meta desktop-only">{{ app_name }} ¬∑ {{ date_str }} ¬∑ {{
            time_str }}</div>
    </footer>
</div>
<script>
  // Make weather data available to JavaScript
  window.WEATHER_DATA = {
    current_temp: {% if weather and weather.current_temp is not none %}{{ weather.current_temp }}{% else %}null{% endif %},
    high_temp: {% if weather and weather.high_temp is not none %}{{ weather.high_temp }}{% else %}null{% endif %},
    low_temp: {% if weather and weather.low_temp is not none %}{{ weather.low_temp }}{% else %}null{% endif %},
    weather_desc: {% if weather and weather.weather_desc %}{{ weather.weather_desc|tojson|safe }}{% else %}""{% endif %}
  };
  window.DAYPART_TEMPS = {{ daypart_temps|tojson|safe if daypart_temps else '{}' }};
  window.TIME_STR = {{ time_str|tojson|safe if time_str else '""' }};
  window.WEEK_GRID = {{ week_grid|tojson|safe if week_grid else '[]' }};
  window.TODAY_DATE = "{{ today_date }}"; /* Ensure this variable exists in context or use JS date */
</script>
{% endblock %}
