{% extends "base.html" %}
{% block content %}
<div class="newspaper" id="js-fit">
    <!-- Masthead -->
    <header class="masthead">
        <div class="masthead__edition">New Haven, Connecticut</div>
        <h1 class="masthead__title">Elm City Daily</h1>
        <div class="masthead__meta">
            <time class="masthead__date">{{ date_str }}</time>
            <span class="masthead__separator">¬∑</span>
            <span class="masthead__tagline">Your Daily Civic Digest</span>
            <button class="masthead__theme" id="js-dark-toggle" type="button" aria-label="Toggle theme">
                <span id="js-theme-icon">‚òÄ</span>
            </button>
        </div>
        <div class="masthead__rule"></div>
    </header>

    <!-- Above the Fold -->
    <main class="broadsheet">
        <!-- Lead Column: Weather & Conditions -->
        <section class="col col--lead" aria-label="Weather and Conditions">
            <article class="weather-block">
                <h2 class="section-head">Today's Conditions</h2>
                <div class="weather-hero">
                    <div class="weather-hero__temp" id="js-temp">
                        {% if weather and weather.current_temp is not none %}
                        {{ weather.current_temp|round|int }}¬∞
                        {% else %}--{% endif %}
                    </div>
                    <div class="weather-hero__desc">
                        {{ weather.weather_desc if weather else 'Loading...' }}
                    </div>
                </div>
                <div class="weather-details">
                    <div class="weather-stat">
                        <span class="weather-stat__label">High</span>
                        <span class="weather-stat__value" id="js-high">{{ weather.high_temp|round|int if weather and weather.high_temp else '--' }}¬∞</span>
                    </div>
                    <div class="weather-stat">
                        <span class="weather-stat__label">Low</span>
                        <span class="weather-stat__value" id="js-low">{{ weather.low_temp|round|int if weather and weather.low_temp else '--' }}¬∞</span>
                    </div>
                    <div class="weather-stat">
                        <span class="weather-stat__label">Sunrise</span>
                        <span class="weather-stat__value">{{ weather.sunrise if weather and weather.sunrise else '--' }}</span>
                    </div>
                    <div class="weather-stat">
                        <span class="weather-stat__label">Sunset</span>
                        <span class="weather-stat__value">{{ weather.sunset if weather and weather.sunset else '--' }}</span>
                    </div>
                </div>
                {% if air_quality and air_quality.available %}
                <div class="aqi-inline">
                    <span class="aqi-inline__badge" style="background:{{ air_quality.color }}">{{ air_quality.aqi }}</span>
                    <span class="aqi-inline__text">{{ air_quality.category }} Air Quality</span>
                </div>
                {% endif %}
            </article>

            <article class="tides-block">
                <h2 class="section-head">Harbor Tides</h2>
                <div id="js-tide-output" class="tides-content">Loading tides...</div>
            </article>

            {% if nws_alerts and nws_alerts|length > 0 %}
            <article class="alerts-block">
                <h2 class="section-head section-head--alert">‚ö† Weather Alerts</h2>
                {% for al in nws_alerts %}
                <a href="{{ al.link }}" target="_blank" rel="noopener" class="alert-item">
                    <strong>{{ al.event }}</strong>: {{ al.headline|truncate(80) if al.headline else al.title }}
                </a>
                {% endfor %}
            </article>
            {% endif %}
        </section>

        <!-- Center Column: Events Calendar -->
        <section class="col col--center" aria-label="This Week's Events">
            <h2 class="section-head section-head--large">This Week in New Haven</h2>
            <div class="week-nav">
                <button id="js-week-prev" class="week-nav__btn" aria-label="Previous week">‚Äπ Prev</button>
                <span id="js-week-label" class="week-nav__label">Week of {{ week_start_date|default('Today') }}</span>
                <button id="js-week-next" class="week-nav__btn" aria-label="Next week">Next ‚Ä∫</button>
            </div>
            
            <div class="calendar-grid" id="js-agenda-week">
                {% for day in week_grid %}
                <div class="calendar-day">
                    <div class="calendar-day__header">{{ day.label }}</div>
                    <div class="calendar-day__events">
                        {% for it in day['items'] %}
                        <button class="event-chip" type="button"
                            data-title="{{ it.title }}"
                            data-time="{{ it.time }}"
                            data-link="{{ it.link }}"
                            data-location="{{ it.location }}"
                            data-source="{{ it.source }}"
                            data-date="{{ it.date }}"
                            data-summary="{{ it.summary | e }}">
                            <span class="event-chip__time">{{ it.time }}</span>
                            <span class="event-chip__title">{{ it.title|truncate(35) }}</span>
                        </button>
                        {% else %}
                        <span class="calendar-day__empty">‚Äî</span>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Event Detail Panel -->
            <aside class="event-detail" id="js-detail" aria-label="Event details">
                <div class="event-detail__card" data-empty="true">
                    <h3 class="event-detail__title" id="js-detail-title">Select an event</h3>
                    <div class="event-detail__meta">
                        <div><strong>When:</strong> <span id="js-detail-when">‚Äî</span></div>
                        <div><strong>Where:</strong> <span id="js-detail-where">‚Äî</span></div>
                        <div><strong>Source:</strong> <span id="js-detail-source">‚Äî</span></div>
                    </div>
                    <p class="event-detail__summary" id="js-detail-summary"></p>
                    <a class="event-detail__link" id="js-detail-link" href="#" target="_blank" rel="noopener" style="display:none;">
                        Read more ‚Üí
                    </a>
                </div>
            </aside>
            <input type="hidden" id="js-week-offset" value="0" />
        </section>

        <!-- Right Column: City Info & Quick Links -->
        <section class="col col--sidebar" aria-label="City Information">
            <!-- Mill Rate & Fiscal Info -->
            {% if tax_info %}
            <article class="infobox">
                <h2 class="section-head">City Finance</h2>
                <div class="stat-row">
                    <span class="stat-row__label">Mill Rate</span>
                    <span class="stat-row__value">{{ tax_info.mill_rate }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-row__label">Fiscal Year</span>
                    <span class="stat-row__value">{{ tax_info.fiscal_year }}</span>
                </div>
            </article>
            {% endif %}

            <!-- Upcoming Meetings -->
            {% if boards_upcoming %}
            <article class="infobox">
                <h2 class="section-head">Upcoming Meetings</h2>
                <ul class="meeting-list">
                    {% for m in boards_upcoming[:5] %}
                    <li class="meeting-item">
                        <a href="{{ m.link or '#' }}" target="_blank" rel="noopener">
                            <span class="meeting-item__title">{{ m.title|truncate(40) }}</span>
                            <span class="meeting-item__date">{{ m.date }}</span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </article>
            {% endif %}

            <!-- Quick Links -->
            <article class="infobox infobox--links">
                <h2 class="section-head">Quick Links</h2>
                <div class="quick-links">
                    <a href="https://seeclickfix.com/new-haven" target="_blank" rel="noopener">üì¢ Report Issue</a>
                    <a href="tel:+12039464800">‚òéÔ∏è City Hall</a>
                    <a href="https://nhfpl.org" target="_blank" rel="noopener">üìö Library</a>
                    <a href="https://www.newhavenct.gov/residents/trash-recycling" target="_blank" rel="noopener">‚ôªÔ∏è Recycling</a>
                    <a href="https://www.newhavenct.gov/residents/parking" target="_blank" rel="noopener">üÖøÔ∏è Parking</a>
                    <a href="https://maps.newhavenct.gov/" target="_blank" rel="noopener">üó∫Ô∏è City Maps</a>
                </div>
            </article>

            <!-- Map -->
            <article class="infobox infobox--map">
                <h2 class="section-head">New Haven</h2>
                <div class="map-embed">
                    <iframe id="js-map-frame" title="New Haven Map" loading="lazy"
                        data-lat="{{ center_lat }}"
                        data-lon="{{ center_lon }}"></iframe>
                </div>
            </article>

            <!-- Sponsors -->
            <article class="infobox infobox--sponsors">
                <h2 class="section-head">New Haven Hangouts</h2>
                <a href="https://ahoyindiemedia.com" target="_blank" rel="noopener sponsored" class="sponsor">
                    <span class="sponsor__icon">‚öì</span>
                    <span class="sponsor__name">Ahoy Indie Media</span>
                </a>
                <div class="sponsor sponsor--placeholder">
                    <span class="sponsor__icon">üìç</span>
                    <span class="sponsor__name">Your Business Here</span>
                </div>
            </article>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer__rule"></div>
        <nav class="footer__nav">
            <a href="{{ url_for('about') }}">About</a>
            <a href="{{ url_for('feeds_api') }}">API</a>
            <button type="button" id="js-refresh" class="footer__refresh">‚Üª Refresh</button>
        </nav>
        <div class="footer__copy">
            ¬© {{ date_str.split(',')[-1].strip() }} Elm City Daily ¬∑ New Haven, CT
        </div>
    </footer>
</div>

<script>
window.WEATHER_DATA = {
    current_temp: {% if weather and weather.current_temp is not none %}{{ weather.current_temp }}{% else %}null{% endif %},
    high_temp: {% if weather and weather.high_temp is not none %}{{ weather.high_temp }}{% else %}null{% endif %},
    low_temp: {% if weather and weather.low_temp is not none %}{{ weather.low_temp }}{% else %}null{% endif %},
    weather_desc: {% if weather and weather.weather_desc %}{{ weather.weather_desc|tojson|safe }}{% else %}""{% endif %},
    sunrise: {% if weather and weather.sunrise %}{{ weather.sunrise|tojson|safe }}{% else %}null{% endif %},
    sunset: {% if weather and weather.sunset %}{{ weather.sunset|tojson|safe }}{% else %}null{% endif %}
};
window.WEEK_GRID = {{ week_grid|tojson|safe if week_grid else '[]' }};
</script>
{% endblock %}
