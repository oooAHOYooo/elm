{% extends "base.html" %}
{% block content %}
<div class="dashboard" id="js-fit">
    <header class="masthead">
        <div class="masthead__title">
            <h1>{{ app_name or "Elm City Daily" }}</h1>
            <span class="live-badge" title="Data updating in real-time">
                <span class="live-badge__dot"></span>
                Live
            </span>
        </div>
        <p class="masthead__date">{{ date_str }}</p>
        <div class="masthead__lines" aria-hidden="true"></div>
        <button class="dark-mode-toggle" id="js-dark-toggle" type="button" aria-label="Toggle dark mode" title="Toggle dark mode">
            <span class="dark-mode-icon" aria-hidden="true">üåô</span>
        </button>
    </header>

    <main class="grid">
        <section class="panel panel--left">
            <!-- Mobile Utility Toggle -->
            <button class="ecd-mobile-accordion-toggle" id="js-utils-toggle" type="button" aria-expanded="false" aria-controls="js-mobile-utils">
                <span class="ecd-site-title">Elm City Daily</span>
                <span class="ecd-mobile-status" id="js-mobile-status-text">
                    <!-- Populated by JS -->
                </span>
                <span class="ecd-mobile-chevron" aria-hidden="true">‚ñæ</span>
            </button>

            <div id="js-mobile-utils" class="ecd-header-utilities">
                <h2 class="panel__title">Local Time & Weather</h2>
                <div class="weather-mini" aria-label="Weather information">
                <div class="weather-mini__controls">
                    <label for="js-units" class="sr-only">Units</label>
                    <select id="js-units" aria-label="Units">
                        <option value="F" selected>¬∞F</option>
                        <option value="C">¬∞C</option>
                    </select>
                </div>
                <div id="js-weather-output" class="weather-mini__output">Weather loading‚Ä¶</div>
            </div>

            <div class="tides-mini" aria-label="Tidal information">
                <div class="tides-mini__controls">
                    <label for="js-tide-date" class="sr-only">Date</label>
                    <select id="js-tide-date" aria-label="Date">
                        <option value="today">Today</option>
                        <option value="tomorrow">Tomorrow</option>
                    </select>
                </div>
                <div id="js-tide-output" class="tides-mini__output">Tides
                    loading‚Ä¶</div>
            </div>

            <!-- Today at a Glance - Auto-generated contextual summary -->
            <div class="today-glance" role="region" aria-label="Today at a Glance">
                <div class="today-glance__header">
                    <span class="today-glance__icon">{{ today_summary.time_context.icon }}</span>
                    <span class="today-glance__greeting">{{ today_summary.time_context.greeting }}, New Haven</span>
                    {% if holiday_info %}
                    <span class="today-glance__holiday" title="{{ holiday_info.type|capitalize }} Holiday">
                        {{ holiday_info.icon }} {{ holiday_info.name }}
                    </span>
                    {% endif %}
                </div>
                
                <div class="today-glance__summary">
                    {% for item in today_summary.summary_items %}
                    <div class="summary-item summary-item--{{ item.type }}">{{ item.text }}</div>
                    {% endfor %}
                </div>
                
                {% if today_summary.tips %}
                <div class="today-glance__tips">
                    <div class="tips-label">Smart Tips</div>
                    {% for tip in today_summary.tips %}
                    <div class="tip-item tip-item--{{ tip.priority }}">
                        <span class="tip-icon">{{ tip.icon }}</span>
                        <span class="tip-text">{{ tip.tip }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            {# History sections omitted for now #}
            <div class="change-nh" role="region"
                aria-label="Change New Haven quick actions">
                <div class="change-nh__title">City Services</div>
                <div class="change-nh__actions">
                    <a class="change-nh__btn change-nh__btn--primary" 
                        href="https://seeclickfix.com/new-haven" target="_blank"
                        rel="noopener" title="Report an Issue">
                        <span class="change-nh__icon">üì¢</span><span
                            class="change-nh__label">Report Issue</span>
                    </a>
                    <a class="change-nh__btn" href="tel:+12039464800"
                        title="City Hall (203-946-4800)">
                        <span class="change-nh__icon">‚òéÔ∏è</span><span
                            class="change-nh__label">311/City</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://newhavenct.legistar.com" target="_blank"
                        rel="noopener" title="Legistar">
                        <span class="change-nh__icon">üìÑ</span><span
                            class="change-nh__label">Legistar</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://www.newhavenct.gov/government/departments-divisions/city-plan"
                        target="_blank" rel="noopener" title="City Plan Dept">
                        <span class="change-nh__icon">üèõÔ∏è</span><span
                            class="change-nh__label">City Plan</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://maps.newhavenct.gov/" target="_blank"
                        rel="noopener" title="Maps">
                        <span class="change-nh__icon">üó∫Ô∏è</span><span
                            class="change-nh__label">Maps</span>
                    </a>
                </div>
                <div class="change-nh__title" style="margin-top: 8px;">Resources</div>
                <div class="change-nh__actions">
                    <a class="change-nh__btn"
                        href="https://www.newhavenct.gov/government/job-opportunities"
                        target="_blank" rel="noopener" title="City Jobs">
                        <span class="change-nh__icon">üíº</span><span
                            class="change-nh__label">City Jobs</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://nhfpl.org" target="_blank"
                        rel="noopener" title="Library">
                        <span class="change-nh__icon">üìö</span><span
                            class="change-nh__label">Library</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://www.newhavenct.gov/residents/parking"
                        target="_blank" rel="noopener" title="Parking">
                        <span class="change-nh__icon">üÖøÔ∏è</span><span
                            class="change-nh__label">Parking</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://www.newhavenct.gov/residents/trash-recycling"
                        target="_blank" rel="noopener" title="Trash & Recycling">
                        <span class="change-nh__icon">‚ôªÔ∏è</span><span
                            class="change-nh__label">Recycling</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://portal.ct.gov/dph" target="_blank"
                        rel="noopener" title="CT Health Dept">
                        <span class="change-nh__icon">üè•</span><span
                            class="change-nh__label">Health</span>
                    </a>
                </div>
                <div class="change-nh__title" style="margin-top: 8px;">Emergency</div>
                <div class="change-nh__actions">
                    <a class="change-nh__btn change-nh__btn--emergency" href="tel:911"
                        title="Emergency 911">
                        <span class="change-nh__icon">üö®</span><span
                            class="change-nh__label">911</span>
                    </a>
                    <a class="change-nh__btn" href="tel:+12039466316"
                        title="Police Non-Emergency">
                        <span class="change-nh__icon">üëÆ</span><span
                            class="change-nh__label">Police</span>
                    </a>
                    <a class="change-nh__btn" href="tel:+12039466262"
                        title="Fire Non-Emergency">
                        <span class="change-nh__icon">üöí</span><span
                            class="change-nh__label">Fire</span>
                    </a>
                    <a class="change-nh__btn"
                        href="https://www.211ct.org/" target="_blank"
                        rel="noopener" title="211 United Way">
                        <span class="change-nh__icon">‚ÑπÔ∏è</span><span
                            class="change-nh__label">211</span>
                    </a>
                </div>
            </div>
            {# Recent council actions omitted #}
            </div> <!-- End ecd-header-utilities -->
        </section>

        <section class="panel panel--center">
            <div class="this-week">
                <header class="week-header desktop-only">
                    <button id="js-week-prev" class="week-nav week-nav-prev" aria-label="Previous week">‚Äπ</button>
                    <div id="js-week-label" class="week-label">Week of {{ week_start_date|default('this week') }}</div>
                    <button id="js-week-next" class="week-nav week-nav-next" aria-label="Next week">‚Ä∫</button>
                </header>

                <div class="ecd-week-wrapper mobile-only">
                     <button class="ecd-week-nav ecd-week-nav--prev" id="js-mobile-week-prev" aria-label="Previous week">‚Äπ</button>
                     <div class="ecd-week-days-scroll" id="js-mobile-week-scroll">
                         <!-- Populated by JS -->
                     </div>
                     <button class="ecd-week-nav ecd-week-nav--next" id="js-mobile-week-next" aria-label="Next week">‚Ä∫</button>
                </div>

                <div class="week-grid desktop-only" id="js-agenda-week">
                    {% for day in week_grid %}
                    <div class="week-day-column">
                        <div class="week-day-header">{{ day.label }}</div>
                        <div class="week-day-body">
                            {% for it in day['items'] %}
                            <button class="week-event-item" type="button"
                                data-title="{{ it.title }}"
                                data-time="{{ it.time }}"
                                data-link="{{ it.link }}"
                                data-location="{{ it.location }}"
                                data-source="{{ it.source }}"
                                data-date="{{ it.date }}"
                                data-summary="{{ it.summary | e }}">
                                <div class="week-event-time">{{ it.time }}</div>
                                <div class="week-event-title">{{ it.title }}</div>
                            </button>
                            {% else %}
                            <div class="week-day-empty">‚Äî</div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="ecd-mobile-events mobile-only">
                     <h2 class="ecd-section-heading">Today</h2>
                     <div class="ecd-mobile-events-today" id="js-mobile-events-today">
                         <!-- Populated by JS -->
                     </div>
                     
                     <h2 class="ecd-section-heading">This Week</h2>
                     <div class="ecd-mobile-events-week" id="js-mobile-events-week">
                        {% for day in week_grid %}
                            {% for it in day['items'] %}
                            <article class="ecd-event-card" 
                                data-date="{{ it.date }}"
                                data-title="{{ it.title }}"
                                data-time="{{ it.time }}"
                                data-link="{{ it.link }}"
                                data-location="{{ it.location }}"
                                data-source="{{ it.source }}"
                                data-summary="{{ it.summary | e }}">
                                <div class="ecd-event-time">{{ it.time }}</div>
                                <div class="ecd-event-title">{{ it.title }}</div>
                                <div class="ecd-event-meta">
                                    {% if it.location %}{{ it.location }}{% endif %}
                                </div>
                            </article>
                            {% endfor %}
                        {% endfor %}
                     </div>
                </div>

                <aside class="week-details ecd-event-details" id="js-detail" aria-label="Event details">
                    <button class="ecd-details-close mobile-only" id="js-details-close" aria-label="Close">√ó</button>
                    <div class="week-details-card" data-empty="true">
                        <div class="week-details-heading">Details</div>
                        <h3 class="week-details-title" id="js-detail-title">Select an event</h3>
                        
                        <div class="week-details-meta">
                            <div class="week-details-row">
                                <span class="label">WHEN</span>
                                <span class="value" id="js-detail-when">‚Äî</span>
                            </div>
                            <div class="week-details-row">
                                <span class="label">WHERE</span>
                                <span class="value" id="js-detail-where">‚Äî</span>
                            </div>
                            <div class="week-details-row">
                                <span class="label">SOURCE</span>
                                <span class="value" id="js-detail-source">‚Äî</span>
                            </div>
                        </div>

                        <hr class="week-details-separator">

                        <div class="week-details-section">
                            <span class="label">ABOUT</span>
                            <div class="week-details-about" id="js-detail-summary"></div>
                        </div>

                        <a class="week-details-link" id="js-detail-link" href="#" target="_blank" rel="noopener" style="display:none;">
                            ‚Üó Open link
                        </a>
                    </div>
                </aside>
                <input type="hidden" id="js-week-offset" value="0" />
            </div>
        </section>

        <aside class="panel panel--right">
            <div class="boards">
                <h3 class="filters__title">Upcoming Boards & Commissions</h3>
                <ul class="list">
                    {% for b in boards_upcoming %}
                    <li class="list__item">
                        <a class="list__link" href="{{ b.link or '#' }}"
                            target="_blank" rel="noopener">
                            <span class="list__source">{{ b.source }} ¬∑ {{
                                b.date }}</span>
                            <span class="list__title">{{ b.title }}</span>
                        </a>
                    </li>
                    {% else %}
                    <li class="list__item list__item--empty">No upcoming
                        meetings.</li>
                    {% endfor %}
                </ul>
            </div>
            
            <button class="ecd-mobile-accordion-toggle ecd-city-map-toggle" id="js-map-toggle" type="button" aria-expanded="false" aria-controls="js-map-stats">
                <span>City Map &amp; Stats</span>
                <span class="ecd-mobile-chevron" aria-hidden="true">‚ñæ</span>
            </button>

            <div class="ecd-city-map-stats" id="js-map-stats">
            <div class="map-controls">
                <label for="js-map-select" class="sr-only">Map Layer</label>
                <select id="js-map-select" class="map-controls__select"
                    aria-label="Select map type">
                    <option value="mapnik">General Map</option>
                    <option value="opentopomap">Topographic</option>
                    <option value="cyclemap">Cycle Routes</option>
                    <option value="transportmap">Public Transport</option>
                </select>
            </div>
            <div class="mapbox" role="region" aria-label="Map of New Haven">
                <iframe id="js-map-frame" title="New Haven Map" loading="lazy"
                    data-lat="{{ center_lat }}"
                    data-lon="{{ center_lon }}"></iframe>
            </div>
            <h2 class="panel__title">City by the Numbers
                <span class="data-freshness" id="js-civics-freshness">
                    <span class="freshness-dot"></span>
                    <span class="freshness-text">Updated just now</span>
                </span>
            </h2>
            <div class="stats stats--compact">
                <div class="stat">
                    <div class="stat__value">{{ civics_stats.introduced }}</div>
                    <div class="stat__label">Matters ({{ civics_stats.since[:10]
                        if civics_stats.since }})</div>
                </div>
                <div class="stat">
                    <div class="stat__value">{{ civics_stats.adopted }}</div>
                    <div class="stat__label">Adopted</div>
                </div>
                <div class="stat">
                    <div class="stat__value">{{ civics_stats.failed }}</div>
                    <div class="stat__label">Failed</div>
                </div>
                <div class="stat">
                    <div class="stat__value">{{ civics_stats.projects_open
                        }}</div>
                    <div class="stat__label">Projects</div>
                </div>
                {% if tax_info and tax_info.mill_rate %}
                <div class="stat">
                    <div class="stat__value">{{
                        '%.2f'|format(tax_info.mill_rate) }}</div>
                    <div class="stat__label">Mill (FY {{ tax_info.fiscal_year
                        }})</div>
                </div>
                {% endif %}
            </div>

            <div class="filters">
                <h3 class="filters__title">Content Filters</h3>
                <div class="filters__grid">
                    <label class="checkbox">
                        <input type="checkbox" class="js-filter"
                            data-category="news" checked />
                        <span>üì∞ News</span>
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" class="js-filter"
                            data-category="events" checked />
                        <span>üìÖ Events</span>
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" class="js-filter"
                            data-category="weather" checked />
                        <span>üå§Ô∏è Weather</span>
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" class="js-filter"
                            data-category="civic" checked />
                        <span>üèõÔ∏è Civic</span>
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" class="js-filter"
                            data-category="arts" checked />
                        <span>üé≠ Arts</span>
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" class="js-filter"
                            data-category="community" checked />
                        <span>ü§ù Community</span>
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" class="js-filter"
                            data-category="fire" checked />
                        <span>üöí Fire/Safety</span>
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" class="js-filter"
                            data-category="food" checked />
                        <span>üçΩÔ∏è Food</span>
                    </label>
                </div>
                <div class="filters__actions">
                    <button type="button" class="filters__btn" id="js-filter-all">Select All</button>
                    <button type="button" class="filters__btn" id="js-filter-none">Clear All</button>
                </div>
            </div>

            <div class="neighborhood-filter">
                <h3 class="filters__title">Neighborhood Focus</h3>
                <select id="js-neighborhood" class="neighborhood-select" aria-label="Filter by neighborhood">
                    <option value="all">All New Haven</option>
                    <optgroup label="Downtown & Central">
                        <option value="downtown">Downtown</option>
                        <option value="wooster-square">Wooster Square</option>
                        <option value="hill">The Hill</option>
                        <option value="dwight">Dwight</option>
                    </optgroup>
                    <optgroup label="East">
                        <option value="east-rock">East Rock</option>
                        <option value="fair-haven">Fair Haven</option>
                        <option value="quinnipiac-meadows">Quinnipiac Meadows</option>
                        <option value="annex">The Annex</option>
                    </optgroup>
                    <optgroup label="West">
                        <option value="westville">Westville</option>
                        <option value="west-rock">West Rock</option>
                        <option value="amity">Amity</option>
                        <option value="beaver-hills">Beaver Hills</option>
                    </optgroup>
                    <optgroup label="North">
                        <option value="newhallville">Newhallville</option>
                        <option value="prospect-hill">Prospect Hill</option>
                        <option value="dixwell">Dixwell</option>
                    </optgroup>
                    <optgroup label="South">
                        <option value="long-wharf">Long Wharf</option>
                        <option value="city-point">City Point</option>
                        <option value="east-shore">East Shore</option>
                    </optgroup>
                </select>
                <p class="neighborhood-note">Focus events & news on your area</p>
            </div>
            <div class="air-quality" role="region" aria-label="Air Quality Index">
                <h3 class="filters__title">Air Quality</h3>
                <div class="aqi-display">
                    {% if air_quality and air_quality.available %}
                    <div class="aqi-badge" style="background-color: {{ air_quality.color }}; color: {% if air_quality.aqi > 100 %}#fff{% else %}#1c1b1a{% endif %};">
                        <span class="aqi-value">{{ air_quality.aqi }}</span>
                        <span class="aqi-label">AQI</span>
                    </div>
                    <div class="aqi-info">
                        <div class="aqi-category">{{ air_quality.emoji }} {{ air_quality.category }}</div>
                        <div class="aqi-pollutant">Primary: {{ air_quality.pollutant or 'N/A' }}</div>
                        <div class="aqi-advice">{{ air_quality.advice }}</div>
                    </div>
                    {% else %}
                    <div class="aqi-unavailable">
                        <span class="aqi-emoji">‚ö™</span>
                        <span>AQI data unavailable</span>
                        <a href="https://www.airnow.gov/?city=New%20Haven&state=CT" target="_blank" rel="noopener" class="aqi-link">Check AirNow ‚Üí</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="alerts">
                <h3 class="filters__title">NWS Alerts</h3>
                <ul class="list list--rail">
                    {% if nws_alerts and nws_alerts|length > 0 %}
                    {% for al in nws_alerts %}
                    <li class="list__item">
                        <a class="list__link" href="{{ al.link }}"
                            target="_blank"
                            rel="noopener">
                            <span class="list__source">{{ al.event }}</span>
                            <span class="list__title">{{ al.title }}</span>
                        </a>
                    </li>
                    {% endfor %}
                    {% else %}
                    <li class="list__item list__item--empty">No active
                        alerts.</li>
                    {% endif %}
                </ul>
            </div>

            <ul class="list list--rail">
                {% for item in right_rail_items %}
                <li class="list__item">
                    <a class="list__link" href="{{ item.link }}" target="_blank"
                        rel="noopener">
                        <span class="list__source">{{ item.source }}</span>
                        <span class="list__title">{{ item.title }}</span>
                    </a>
                </li>
                {% endfor %}
            </ul>
            </div> <!-- End ecd-city-map-stats -->
        </aside>
    </main>

    <section class="strip desktop-only">
        <div class="strip__inner">
            {% for item in bottom_strip_items %}
            {% if item.category == 'events' %}
            <div class="card" data-category="events">
                <div class="card__badge">Event</div>
                <div class="card__title">{{ item.title }}</div>
                <div class="card__meta">
                    {% if item.location %}{{ item.location }} ¬∑ {% endif %}
                    {% if item.published_display %}{{ item.published_display
                    }}{% endif %}
                </div>
            </div>
            {% elif item.category == 'weather' %}
            <div class="card" data-category="weather">
                <div class="card__badge">Weather</div>
                <div class="card__title">{{ item.title }}</div>
                <div class="card__meta">{{ item.summary }}</div>
            </div>
            {% else %}
            <a class="card" href="{{ item.link }}" target="_blank"
                rel="noopener" data-category="news">
                <div class="card__badge">News</div>
                <div class="card__title">{{ item.title }}</div>
                <div class="card__meta">{{ item.source }}</div>
            </a>
            {% endif %}
            {% endfor %}
        </div>
    </section>
    <footer class="footer-mini">
        <nav class="footer-mini__nav">
            <a href="{{ url_for('about') }}">About</a>
            <a href="{{ url_for('feeds_view') }}">Feeds</a>
            <a href="{{ url_for('feeds_api') }}">API</a>
            <button type="button" class="refresh-btn" id="js-refresh" title="Refresh data">
                <span class="refresh-icon">‚Üª</span>
                <span class="refresh-text">Refresh</span>
            </button>
            <span class="mobile-only">¬© Elm City Daily</span>
        </nav>
        <div class="footer-mini__meta desktop-only">
            {{ app_name }} ¬∑ {{ date_str }} ¬∑ {{ time_str }}
            <span class="auto-refresh-status" id="js-auto-refresh-status">
                ¬∑ Auto-refresh: <button type="button" id="js-auto-refresh-toggle" class="auto-refresh-toggle">OFF</button>
            </span>
        </div>
    </footer>
</div>
<script>
  // Make weather data available to JavaScript
  window.WEATHER_DATA = {
    current_temp: {% if weather and weather.current_temp is not none %}{{ weather.current_temp }}{% else %}null{% endif %},
    high_temp: {% if weather and weather.high_temp is not none %}{{ weather.high_temp }}{% else %}null{% endif %},
    low_temp: {% if weather and weather.low_temp is not none %}{{ weather.low_temp }}{% else %}null{% endif %},
    weather_desc: {% if weather and weather.weather_desc %}{{ weather.weather_desc|tojson|safe }}{% else %}""{% endif %}
  };
  window.DAYPART_TEMPS = {{ daypart_temps|tojson|safe if daypart_temps else '{}' }};
  window.TIME_STR = {{ time_str|tojson|safe if time_str else '""' }};
  window.WEEK_GRID = {{ week_grid|tojson|safe if week_grid else '[]' }};
  window.TODAY_DATE = "{{ today_date }}"; /* Ensure this variable exists in context or use JS date */
</script>
{% endblock %}
