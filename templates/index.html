{% extends "base.html" %}
{% block content %}
<div class="newspaper" id="js-fit">
    <!-- Masthead -->
    <header class="masthead">
        <div class="masthead__edition">New Haven, Connecticut</div>
        <h1 class="masthead__title">Elm City Daily</h1>
        <div class="masthead__meta">
            <time class="masthead__date">{{ date_str }}</time>
            <span class="masthead__separator">Â·</span>
            <span class="masthead__tagline">Your Daily Civic Digest</span>
            <button class="masthead__theme" id="js-dark-toggle" type="button" aria-label="Toggle theme">
                <span id="js-theme-icon">â˜€</span>
            </button>
        </div>
        <div class="masthead__rule"></div>
    </header>

    <!-- Above the Fold -->
    <main class="broadsheet">
        <!-- Lead Column: Weather & Conditions -->
        <section class="col col--lead" aria-label="Weather and Conditions">
            <article class="weather-block">
                <h2 class="section-head">Today's Conditions</h2>
                <div class="weather-hero">
                    <div class="weather-hero__temp" id="js-temp">
                        {% if weather and weather.current_temp is not none %}
                        {{ weather.current_temp|round|int }}Â°
                        {% else %}--{% endif %}
                    </div>
                    <div class="weather-hero__desc">
                        {{ weather.weather_desc if weather else 'Loading...' }}
                    </div>
                </div>
                <div class="weather-details">
                    <div class="weather-stat">
                        <span class="weather-stat__label">High</span>
                        <span class="weather-stat__value" id="js-high">{{ weather.high_temp|round|int if weather and weather.high_temp else '--' }}Â°</span>
                    </div>
                    <div class="weather-stat">
                        <span class="weather-stat__label">Low</span>
                        <span class="weather-stat__value" id="js-low">{{ weather.low_temp|round|int if weather and weather.low_temp else '--' }}Â°</span>
                    </div>
                    <div class="weather-stat">
                        <span class="weather-stat__label">Sunrise</span>
                        <span class="weather-stat__value">{{ weather.sunrise if weather and weather.sunrise else '--' }}</span>
                    </div>
                    <div class="weather-stat">
                        <span class="weather-stat__label">Sunset</span>
                        <span class="weather-stat__value">{{ weather.sunset if weather and weather.sunset else '--' }}</span>
                    </div>
                </div>
                {% if air_quality and air_quality.available %}
                <div class="aqi-inline">
                    <span class="aqi-inline__badge" style="background:{{ air_quality.color }}">{{ air_quality.aqi }}</span>
                    <span class="aqi-inline__text">{{ air_quality.category }} Air Quality</span>
                </div>
                {% endif %}
            </article>

            <article class="tides-block">
                <h2 class="section-head">Harbor Tides</h2>
                <div id="js-tide-output" class="tides-content">Loading tides...</div>
            </article>

            {% if nws_alerts and nws_alerts|length > 0 %}
            <article class="alerts-block">
                <h2 class="section-head section-head--alert">âš  Weather Alerts</h2>
                {% for al in nws_alerts %}
                <a href="{{ al.link }}" target="_blank" rel="noopener" class="alert-item">
                    <strong>{{ al.event }}</strong>: {{ al.headline|truncate(80) if al.headline else al.title }}
                </a>
                {% endfor %}
            </article>
            {% endif %}
        </section>

        <!-- Center Column: Events Calendar -->
        <section class="col col--center" aria-label="This Week's Events">
            <h2 class="section-head section-head--large">This Week in New Haven</h2>
            <div class="week-nav">
                <button id="js-week-prev" class="week-nav__btn" aria-label="Previous week">â€¹ Prev</button>
                <span id="js-week-label" class="week-nav__label">Week of {{ week_start_date|default('Today') }}</span>
                <button id="js-week-next" class="week-nav__btn" aria-label="Next week">Next â€º</button>
            </div>
            
            <div class="calendar-grid" id="js-agenda-week">
                {% for day in week_grid %}
                <div class="calendar-day">
                    <div class="calendar-day__header">{{ day.label }}</div>
                    <div class="calendar-day__events">
                        {% for it in day['items'] %}
                        <button class="event-chip" type="button"
                            data-title="{{ it.title }}"
                            data-time="{{ it.time }}"
                            data-link="{{ it.link }}"
                            data-location="{{ it.location }}"
                            data-source="{{ it.source }}"
                            data-date="{{ it.date }}"
                            data-summary="{{ it.summary | e }}">
                            <span class="event-chip__time">{{ it.time }}</span>
                            <span class="event-chip__title">{{ it.title|truncate(35) }}</span>
                        </button>
                        {% else %}
                        <span class="calendar-day__empty">â€”</span>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Event Detail Panel -->
            <aside class="event-detail" id="js-detail" aria-label="Event details">
                <div class="event-detail__card" data-empty="true">
                    <h3 class="event-detail__title" id="js-detail-title">Select an event</h3>
                    <div class="event-detail__meta">
                        <div><strong>When:</strong> <span id="js-detail-when">â€”</span></div>
                        <div><strong>Where:</strong> <span id="js-detail-where">â€”</span></div>
                        <div><strong>Source:</strong> <span id="js-detail-source">â€”</span></div>
                    </div>
                    <p class="event-detail__summary" id="js-detail-summary"></p>
                    <a class="event-detail__link" id="js-detail-link" href="#" target="_blank" rel="noopener" style="display:none;">
                        Read more â†’
                    </a>
                </div>
            </aside>
            <input type="hidden" id="js-week-offset" value="0" />
        </section>

        <!-- Right Column: City Info & Quick Links -->
        <section class="col col--sidebar" aria-label="City Information">
            <!-- Mill Rate & Fiscal Info -->
            {% if tax_info %}
            <article class="infobox">
                <h2 class="section-head">City Finance</h2>
                <div class="stat-row">
                    <span class="stat-row__label">Mill Rate</span>
                    <span class="stat-row__value">{{ tax_info.mill_rate }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-row__label">Fiscal Year</span>
                    <span class="stat-row__value">{{ tax_info.fiscal_year }}</span>
                </div>
            </article>
            {% endif %}

            <!-- Upcoming Meetings -->
            {% if boards_upcoming %}
            <article class="infobox">
                <h2 class="section-head">Upcoming Meetings</h2>
                <ul class="meeting-list">
                    {% for m in boards_upcoming[:5] %}
                    <li class="meeting-item">
                        <a href="{{ m.link or '#' }}" target="_blank" rel="noopener">
                            <span class="meeting-item__title">{{ m.title|truncate(40) }}</span>
                            <span class="meeting-item__date">{{ m.date }}</span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </article>
            {% endif %}

            <!-- Quick Links with Popups -->
            <article class="infobox infobox--links">
                <h2 class="section-head">Quick Links</h2>
                <div class="quick-links">
                    <button class="quick-link" data-popup="seeclickfix">ğŸ“¢ Report Issue</button>
                    <button class="quick-link" data-popup="cityhall">â˜ï¸ City Hall</button>
                    <button class="quick-link" data-popup="library">ğŸ“š Library</button>
                    <button class="quick-link" data-popup="recycling">â™»ï¸ Recycling</button>
                    <button class="quick-link" data-popup="parking">ğŸ…¿ï¸ Parking</button>
                    <button class="quick-link" data-popup="transit">ğŸšŒ Transit</button>
                </div>
            </article>

            <!-- Map -->
            <article class="infobox infobox--map">
                <h2 class="section-head">New Haven</h2>
                <div class="map-embed">
                    <iframe id="js-map-frame" title="New Haven Map" loading="lazy"
                        data-lat="{{ center_lat }}"
                        data-lon="{{ center_lon }}"></iframe>
                </div>
            </article>

            <!-- Sponsors -->
            <article class="infobox infobox--sponsors">
                <h2 class="section-head">New Haven Hangouts</h2>
                <a href="https://ahoyindiemedia.com" target="_blank" rel="noopener sponsored" class="sponsor">
                    <span class="sponsor__icon">âš“</span>
                    <span class="sponsor__name">Ahoy Indie Media</span>
                </a>
                <div class="sponsor sponsor--placeholder">
                    <span class="sponsor__icon">ğŸ“</span>
                    <span class="sponsor__name">Your Business Here</span>
                </div>
            </article>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer__rule"></div>
        <nav class="footer__nav">
            <a href="{{ url_for('about') }}">About</a>
            <a href="{{ url_for('feeds_api') }}">API</a>
            <a href="{{ url_for('feeds_rss') }}" title="RSS Feed">ğŸ“° RSS</a>
            <button type="button" id="js-refresh" class="footer__refresh">â†» Refresh</button>
        </nav>
        <div class="footer__freshness">
            <span id="js-last-updated">Updated just now</span>
        </div>
        <div class="footer__copy">
            Â© {{ date_str.split(',')[-1].strip() }} Elm City Daily Â· New Haven, CT
        </div>
    </footer>
</div>

<!-- Popup Panels -->
<div class="popup-overlay" id="popup-overlay"></div>

<div class="popup-panel" id="popup-seeclickfix" data-popup="seeclickfix">
    <div class="popup-header">
        <h3>ğŸ“¢ Report an Issue</h3>
        <button class="popup-close" aria-label="Close">Ã—</button>
    </div>
    <div class="popup-body">
        <iframe src="https://seeclickfix.com/new-haven" title="SeeClickFix"></iframe>
    </div>
    <div class="popup-footer">
        <a href="https://seeclickfix.com/new-haven" target="_blank" rel="noopener">Open in new tab â†’</a>
    </div>
</div>

<div class="popup-panel" id="popup-cityhall" data-popup="cityhall">
    <div class="popup-header">
        <h3>â˜ï¸ City Hall</h3>
        <button class="popup-close" aria-label="Close">Ã—</button>
    </div>
    <div class="popup-body popup-body--content">
        <div class="popup-info">
            <h4>New Haven City Hall</h4>
            <p>165 Church Street, New Haven, CT 06510</p>
            <div class="popup-stat"><strong>Main:</strong> <a href="tel:+12039464800">(203) 946-4800</a></div>
            <div class="popup-stat"><strong>311:</strong> <a href="tel:311">311</a></div>
            <div class="popup-stat"><strong>Hours:</strong> Mon-Fri 9am-5pm</div>
        </div>
        <div class="popup-section">
            <h5>Key Departments</h5>
            <ul>
                <li><strong>Mayor's Office:</strong> (203) 946-8200</li>
                <li><strong>City Clerk:</strong> (203) 946-8350</li>
                <li><strong>Finance:</strong> (203) 946-6480</li>
                <li><strong>Public Works:</strong> (203) 946-8112</li>
                <li><strong>Parks & Rec:</strong> (203) 946-8027</li>
            </ul>
        </div>
    </div>
    <div class="popup-footer">
        <a href="https://www.newhavenct.gov" target="_blank" rel="noopener">Visit City Website â†’</a>
    </div>
</div>

<div class="popup-panel" id="popup-library" data-popup="library">
    <div class="popup-header">
        <h3>ğŸ“š Library</h3>
        <button class="popup-close" aria-label="Close">Ã—</button>
    </div>
    <div class="popup-body popup-body--content">
        <div class="popup-info">
            <h4>New Haven Free Public Library</h4>
            <p>133 Elm Street (Ives Main)</p>
            <div class="popup-stat"><strong>Phone:</strong> <a href="tel:+12039468130">(203) 946-8130</a></div>
        </div>
        <div class="popup-section">
            <h5>Branch Hours Today</h5>
            <ul>
                <li><strong>Ives Main:</strong> 10am - 8pm</li>
                <li><strong>Fair Haven:</strong> 10am - 6pm</li>
                <li><strong>Mitchell:</strong> 10am - 6pm</li>
                <li><strong>Stetson:</strong> 10am - 6pm</li>
                <li><strong>Wilson:</strong> 10am - 6pm</li>
            </ul>
        </div>
        <div class="popup-section">
            <h5>Quick Services</h5>
            <ul>
                <li>Free WiFi & Computer Access</li>
                <li>3D Printing & Makerspace</li>
                <li>Museum Passes Available</li>
                <li>ESL Classes & Tutoring</li>
            </ul>
        </div>
    </div>
    <div class="popup-footer">
        <a href="https://nhfpl.org" target="_blank" rel="noopener">Visit NHFPL â†’</a>
    </div>
</div>

<div class="popup-panel" id="popup-recycling" data-popup="recycling">
    <div class="popup-header">
        <h3>â™»ï¸ Trash & Recycling</h3>
        <button class="popup-close" aria-label="Close">Ã—</button>
    </div>
    <div class="popup-body popup-body--content">
        <div class="popup-info">
            <h4>Collection Schedule</h4>
            <div class="popup-stat"><strong>Hotline:</strong> <a href="tel:+12039467700">(203) 946-7700</a></div>
        </div>
        <div class="popup-section">
            <h5>This Week's Pickup</h5>
            <ul>
                <li><strong>Zone A (Downtown):</strong> Monday</li>
                <li><strong>Zone B (East Rock/Westville):</strong> Tuesday</li>
                <li><strong>Zone C (Fair Haven/Annex):</strong> Wednesday</li>
                <li><strong>Zone D (Dixwell/Newhallville):</strong> Thursday</li>
                <li><strong>Zone E (West/Hill):</strong> Friday</li>
            </ul>
        </div>
        <div class="popup-section">
            <h5>What Goes Where</h5>
            <ul>
                <li>ğŸ”µ <strong>Blue Bin:</strong> Paper, cardboard, plastics 1-7</li>
                <li>ğŸŸ¢ <strong>Green Bin:</strong> Glass bottles & jars</li>
                <li>â¬› <strong>Trash:</strong> Everything else</li>
                <li>ğŸ‚ <strong>Yard Waste:</strong> Paper bags only, Apr-Dec</li>
            </ul>
        </div>
    </div>
    <div class="popup-footer">
        <a href="https://www.newhavenct.gov/residents/trash-recycling" target="_blank" rel="noopener">Full Schedule â†’</a>
    </div>
</div>

<div class="popup-panel" id="popup-parking" data-popup="parking">
    <div class="popup-header">
        <h3>ğŸ…¿ï¸ Parking</h3>
        <button class="popup-close" aria-label="Close">Ã—</button>
    </div>
    <div class="popup-body popup-body--content">
        <div class="popup-info">
            <h4>Parking Authority</h4>
            <div class="popup-stat"><strong>Phone:</strong> <a href="tel:+12039468075">(203) 946-8075</a></div>
        </div>
        <div class="popup-section">
            <h5>Downtown Garages</h5>
            <ul>
                <li><strong>Temple St:</strong> ğŸŸ¢ Available (342/500)</li>
                <li><strong>Crown St:</strong> ğŸŸ¡ Filling (89/200)</li>
                <li><strong>Air Rights:</strong> ğŸŸ¢ Available (567/800)</li>
                <li><strong>Church St South:</strong> ğŸŸ¢ Available (234/400)</li>
            </ul>
        </div>
        <div class="popup-section">
            <h5>Meter Rates</h5>
            <ul>
                <li><strong>Downtown:</strong> $1.50/hr (2hr max)</li>
                <li><strong>Residential:</strong> $0.75/hr</li>
                <li><strong>Evenings (6pm+):</strong> Free</li>
                <li><strong>Sundays:</strong> Free</li>
            </ul>
        </div>
    </div>
    <div class="popup-footer">
        <a href="https://www.newhavenct.gov/residents/parking" target="_blank" rel="noopener">Pay Ticket Online â†’</a>
    </div>
</div>

<div class="popup-panel" id="popup-transit" data-popup="transit">
    <div class="popup-header">
        <h3>ğŸšŒ Transit</h3>
        <button class="popup-close" aria-label="Close">Ã—</button>
    </div>
    <div class="popup-body popup-body--content">
        <div class="popup-info">
            <h4>CT Transit New Haven</h4>
            <div class="popup-stat"><strong>Info:</strong> <a href="tel:+12036247433">(203) 624-0151</a></div>
        </div>
        <div class="popup-section">
            <h5>Union Station Departures</h5>
            <ul>
                <li><strong>Route B1 (Branford):</strong> 12 min</li>
                <li><strong>Route C (Downtown):</strong> 5 min</li>
                <li><strong>Route D (Long Wharf):</strong> 8 min</li>
                <li><strong>Route J (Yale):</strong> 3 min</li>
                <li><strong>Route O (Orange):</strong> 15 min</li>
            </ul>
        </div>
        <div class="popup-section">
            <h5>Metro-North (Shore Line East)</h5>
            <ul>
                <li><strong>To NYC:</strong> Next train 2:45pm</li>
                <li><strong>To Stamford:</strong> Next train 3:12pm</li>
                <li><strong>To New London:</strong> Next train 2:58pm</li>
            </ul>
        </div>
    </div>
    <div class="popup-footer">
        <a href="https://www.cttransit.com" target="_blank" rel="noopener">CT Transit â†’</a>
    </div>
</div>

<script>
window.WEATHER_DATA = {
    current_temp: {% if weather and weather.current_temp is not none %}{{ weather.current_temp }}{% else %}null{% endif %},
    high_temp: {% if weather and weather.high_temp is not none %}{{ weather.high_temp }}{% else %}null{% endif %},
    low_temp: {% if weather and weather.low_temp is not none %}{{ weather.low_temp }}{% else %}null{% endif %},
    weather_desc: {% if weather and weather.weather_desc %}{{ weather.weather_desc|tojson|safe }}{% else %}""{% endif %},
    sunrise: {% if weather and weather.sunrise %}{{ weather.sunrise|tojson|safe }}{% else %}null{% endif %},
    sunset: {% if weather and weather.sunset %}{{ weather.sunset|tojson|safe }}{% else %}null{% endif %}
};
window.WEEK_GRID = {{ week_grid|tojson|safe if week_grid else '[]' }};
</script>
{% endblock %}
